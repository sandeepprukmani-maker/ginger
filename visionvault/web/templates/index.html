<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automation AI-Powered</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: #111111;
            border-right: 1px solid #1f1f1f;
            padding: 24px 0;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .logo-section {
            padding: 0 24px 32px 24px;
            border-bottom: 1px solid #1f1f1f;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .logo-title {
            font-size: 15px;
            font-weight: 700;
            color: #ffffff;
            line-height: 1.2;
        }

        .logo-subtitle {
            font-size: 10px;
            color: #8b5cf6;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-section {
            padding: 24px 0;
            flex: 1;
        }

        .nav-title {
            font-size: 11px;
            color: #555555;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 24px 12px 24px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 24px;
            color: #888888;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-link:hover {
            color: #ffffff;
            background: rgba(139, 92, 246, 0.1);
        }

        .nav-link.active {
            color: #ffffff;
            background: rgba(139, 92, 246, 0.15);
            border-left-color: #8b5cf6;
        }

        .nav-link i {
            font-size: 16px;
            width: 18px;
        }

        .sidebar-footer {
            padding: 20px 24px;
            border-top: 1px solid #1f1f1f;
        }

        .status-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 12px;
            color: #888888;
        }

        .status-label {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-value {
            color: #10b981;
            font-weight: 600;
        }

        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 0;
            position: relative;
        }

        .top-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 16px 48px;
            gap: 12px;
            border-bottom: 1px solid #1f1f1f;
        }

        .connected-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #8b5cf6;
            color: #ffffff;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
        }

        .connected-badge.disconnected {
            background: #333333;
            color: #888888;
        }

        .icon-button {
            width: 36px;
            height: 36px;
            background: transparent;
            border: 1px solid #333333;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #888888;
            transition: all 0.2s;
        }

        .icon-button:hover {
            background: #1a1a1a;
            border-color: #555555;
            color: #ffffff;
        }

        .content-wrapper {
            padding: 40px 48px;
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #ffffff;
        }

        .page-subtitle {
            font-size: 15px;
            color: #888888;
        }

        .mode-toggle {
            display: flex;
            gap: 0;
            margin-bottom: 32px;
            width: fit-content;
            background: #1a1a1a;
            border-radius: 10px;
            padding: 4px;
        }

        .mode-button {
            display: flex;
            align-items: center;
            gap: 8px;
            background: transparent;
            color: #888888;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-button.active {
            background: #8b5cf6;
            color: #ffffff;
        }

        .mode-button i {
            font-size: 16px;
        }

        .form-section {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #cccccc;
            margin-bottom: 12px;
        }

        .prompt-input {
            width: 100%;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 16px 20px;
            color: #ffffff;
            font-size: 14px;
            line-height: 1.8;
            resize: vertical;
            min-height: 140px;
            transition: all 0.2s;
            font-family: inherit;
        }

        .prompt-input:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .prompt-input::placeholder {
            color: #555555;
        }

        .hint-text {
            font-size: 12px;
            color: #666666;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .execute-button {
            width: 100%;
            background: #8b5cf6;
            color: #ffffff;
            border: none;
            border-radius: 10px;
            padding: 14px 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }

        .execute-button:hover:not(:disabled) {
            background: #7c3aed;
            transform: translateY(-1px);
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.3);
        }

        .execute-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 32px;
        }

        .result-panel {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            min-height: 320px;
        }

        .panel-title {
            font-size: 13px;
            font-weight: 600;
            color: #cccccc;
            margin-bottom: 16px;
        }

        .panel-content {
            background: #0f0f0f;
            border: 1px solid #1f1f1f;
            border-radius: 8px;
            padding: 16px;
            min-height: 260px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .empty-state {
            color: #555555;
            font-size: 13px;
            text-align: center;
        }

        .log-container {
            background: #0f0f0f;
            border: 1px solid #1f1f1f;
            border-radius: 8px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #10b981;
            max-height: 260px;
            overflow-y: auto;
            line-height: 1.6;
        }

        .log-line {
            padding: 3px 0;
        }

        .code-block {
            background: #0f0f0f;
            border: 1px solid #1f1f1f;
            border-radius: 8px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            color: #e2e8f0;
            white-space: pre-wrap;
            max-height: 260px;
            overflow-y: auto;
            line-height: 1.6;
        }

        .screenshot-container {
            background: #0f0f0f;
            border: 1px solid #1f1f1f;
            border-radius: 8px;
            overflow: hidden;
            min-height: 260px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .screenshot-container img {
            width: 100%;
            height: auto;
            display: block;
        }

        .status-alert {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 10px;
            padding: 14px 18px;
            margin-top: 20px;
            font-size: 13px;
            color: #ffffff;
        }

        .hidden {
            display: none;
        }

        .history-item {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            border-color: #8b5cf6;
            transform: translateX(2px);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-success { background: #10b981; color: white; }
        .status-failed { background: #ef4444; color: white; }
        .status-pending { background: #f59e0b; color: white; }
        .status-running { background: #3b82f6; color: white; }

        .element-selector-widget {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(26, 26, 26, 0.98);
            border: 2px solid #8b5cf6;
            border-radius: 16px;
            padding: 0;
            z-index: 10000;
            min-width: 400px;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(139, 92, 246, 0.3);
            backdrop-filter: blur(10px);
            animation: widgetFadeIn 0.3s ease-out;
        }

        @keyframes widgetFadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -45%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100px);
            }
        }

        .widget-header {
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
            color: white;
            padding: 16px 20px;
            border-radius: 14px 14px 0 0;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: move;
            font-weight: 600;
            font-size: 15px;
        }

        .widget-body {
            padding: 24px 20px;
        }

        .widget-message {
            color: #ffffff;
            font-size: 14px;
            line-height: 1.6;
            margin: 0 0 16px 0;
            padding: 12px;
            background: rgba(139, 92, 246, 0.1);
            border-left: 3px solid #8b5cf6;
            border-radius: 6px;
        }

        .widget-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 8px;
            color: #fbbf24;
            font-size: 13px;
            font-weight: 500;
        }

        .widget-status i {
            font-size: 16px;
        }

        /* Light Theme */
        .light-theme {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #1a1a1a;
            --text-secondary: #4a5568;
            --border-color: #dee2e6;
        }

        .light-theme body {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .light-theme .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
        }

        .light-theme .nav-link {
            color: var(--text-secondary);
        }

        .light-theme .nav-link:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .light-theme .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .light-theme .top-bar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .light-theme .icon-button {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .light-theme .icon-button:hover {
            background: #cbd5e0;
        }

        .light-theme .prompt-input,
        .light-theme textarea {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .light-theme .result-panel,
        .light-theme .form-section {
            background: var(--bg-secondary);
            border-color: var(--border-color);
        }

        .light-theme .panel-title {
            color: var(--text-primary);
            border-bottom-color: var(--border-color);
        }

        .light-theme code,
        .light-theme pre {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .light-theme .status-item {
            color: var(--text-secondary);
        }

        .light-theme .nav-title {
            color: var(--text-secondary);
        }

        .light-theme .hint-text {
            color: var(--text-secondary);
        }

        .light-theme .page-subtitle {
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="logo-section">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="bi bi-robot"></i>
                    </div>
                    <div class="logo-text">
                        <div class="logo-title">Automation</div>
                        <div class="logo-subtitle">AI-Powered</div>
                    </div>
                </div>
            </div>
            
            <nav class="nav-section">
                <div class="nav-title">Navigation</div>
                <a href="#" class="nav-link active" onclick="showDashboard(); return false;">
                    <i class="bi bi-grid-fill"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-link" onclick="showHistory(); return false;">
                    <i class="bi bi-clock-history"></i>
                    <span>History</span>
                </a>
                <a href="#" class="nav-link" onclick="showConfiguration(); return false;">
                    <i class="bi bi-gear-fill"></i>
                    <span>Configuration</span>
                </a>
                
                <div class="nav-title" style="margin-top: 24px;">Scripts & Library</div>
                <a href="#" class="nav-link" onclick="showScriptsLibrary(); return false;">
                    <i class="bi bi-file-code-fill"></i>
                    <span>Scripts Library</span>
                </a>
                <a href="#" class="nav-link" onclick="showTaskLibrary(); return false;">
                    <i class="bi bi-book-fill"></i>
                    <span>Task Library</span>
                </a>
                
                <div class="nav-title" style="margin-top: 24px;">Learning</div>
                <a href="#" class="nav-link" onclick="showTeachingMode(); return false;">
                    <i class="bi bi-camera-video-fill"></i>
                    <span>Teaching Mode</span>
                </a>
                <a href="#" class="nav-link" onclick="showRecallMode(); return false;">
                    <i class="bi bi-lightning-charge-fill"></i>
                    <span>Recall Mode</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="status-item">
                    <span class="status-label">
                        <i class="bi bi-check-circle-fill"></i>
                        GPT-5 Enabled
                    </span>
                </div>
                <div class="status-item">
                    <span class="status-label">
                        <i class="bi bi-check-circle-fill"></i>
                        Playwright Ready
                    </span>
                    <span class="status-value">v1.0</span>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <div class="top-bar">
                <div id="connectedBadge" class="connected-badge disconnected">
                    <i class="bi bi-wifi-off"></i>
                    <span>Disconnected</span>
                </div>
                <button class="icon-button" onclick="toggleTheme()" id="themeToggle" title="Toggle theme">
                    <i class="bi bi-moon-stars-fill"></i>
                </button>
            </div>

            <div class="content-wrapper">
                <div id="dashboardView">
                    <div class="page-header">
                        <h1 class="page-title">Automation Dashboard</h1>
                        <p class="page-subtitle">Create browser automations using natural language</p>
                    </div>

                    <div class="form-section" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(109, 40, 217, 0.05) 100%); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <i class="bi bi-cpu" style="font-size: 20px; color: #8b5cf6;"></i>
                            <label class="form-label" style="margin: 0; color: #ffffff; font-weight: 600;">Intelligent Engine Selection</label>
                        </div>
                        <p style="margin: 0; font-size: 13px; color: #888888; line-height: 1.5;">
                            VisionVault automatically chooses the best automation strategy based on your task complexity. 
                            <span style="color: #8b5cf6; font-weight: 500;">MCP Enhanced</span> for fast single actions, 
                            <span style="color: #8b5cf6; font-weight: 500;">Code Generation</span> for complex workflows.
                        </p>
                    </div>

                    <div class="form-section">
                        <label class="form-label">Browser Mode</label>
                        <div class="mode-toggle">
                            <button class="mode-button active" id="headlessBtn" onclick="setMode('headless')">
                                <i class="bi bi-display"></i>
                                <span>Headless</span>
                            </button>
                            <button class="mode-button" id="headfulBtn" onclick="setMode('headful')">
                                <i class="bi bi-eye"></i>
                                <span>Headful</span>
                            </button>
                        </div>
                    </div>

                    <div class="form-section">
                        <label class="form-label">Automation Prompt</label>
                        <textarea class="prompt-input" id="commandInput" placeholder="Describe your automation task in natural language...

Example: Check my Gmail inbox for invoices and download them
Example: Navigate to Amazon and search for wireless headphones
Example: Go to LinkedIn and extract all job postings for Software Engineer"></textarea>
                        <div class="hint-text">
                            <span>Press</span>
                            <kbd style="background: #2a2a2a; padding: 2px 6px; border-radius: 4px; font-size: 11px;">âŒ˜</kbd>
                            <span>+</span>
                            <kbd style="background: #2a2a2a; padding: 2px 6px; border-radius: 4px; font-size: 11px;">Enter</kbd>
                            <span>to execute</span>
                            <span style="margin-left: auto; color: #555555;" id="charCount">0 characters</span>
                        </div>
                    </div>

                    <button class="execute-button" id="executeButton" onclick="executeTest()">
                        <i class="bi bi-play-fill"></i>
                        <span>Execute Automation</span>
                    </button>

                    <div id="statusAlert" class="status-alert hidden">
                        <strong><i class="bi bi-hourglass-split"></i> Status:</strong> <span id="statusMessage">Initializing...</span>
                    </div>

                    <div class="results-grid" style="grid-template-columns: repeat(2, 1fr); margin-bottom: 24px;">
                        <div class="result-panel">
                            <div class="panel-title" style="display: flex; justify-content: space-between; align-items: center;">
                                <span><i class="bi bi-code-square"></i> Generated Script</span>
                                <button id="downloadGeneratedBtn" class="icon-button" onclick="downloadGeneratedScript()" style="display: none;" title="Download script">
                                    <i class="bi bi-download"></i>
                                </button>
                            </div>
                            <div class="panel-content" id="scriptPanel">
                                <div class="empty-state">No script generated yet</div>
                            </div>
                        </div>
                        <div class="result-panel">
                            <div class="panel-title" style="display: flex; justify-content: space-between; align-items: center;">
                                <span>
                                    <i class="bi bi-wrench"></i> Healed Script
                                    <span style="font-size: 11px; background: rgba(139, 92, 246, 0.2); color: #a78bfa; padding: 2px 8px; border-radius: 4px; margin-left: 8px;">SMART</span>
                                </span>
                                <button id="downloadHealedBtn" class="icon-button" onclick="downloadHealedScript()" style="display: none;" title="Download healed script">
                                    <i class="bi bi-download"></i>
                                </button>
                            </div>
                            <div class="panel-content" id="healedScriptPanel">
                                <div class="empty-state">No healed script yet</div>
                            </div>
                        </div>
                    </div>

                    <div class="results-grid" style="grid-template-columns: repeat(2, 1fr);">
                        <div class="result-panel">
                            <div class="panel-title">
                                <i class="bi bi-camera-fill"></i> Screenshot
                            </div>
                            <div class="panel-content" id="screenshotPanel">
                                <div class="empty-state">No screenshot available</div>
                            </div>
                        </div>
                        <div class="result-panel">
                            <div class="panel-title">
                                <i class="bi bi-list-ul"></i> Execution Logs
                            </div>
                            <div class="panel-content" id="logsPanel">
                                <div class="empty-state">No logs yet</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="historyView" class="hidden">
                    <div class="page-header">
                        <h1 class="page-title">Test History</h1>
                        <p class="page-subtitle">View your past automation executions</p>
                    </div>

                    <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                        <button class="execute-button" style="width: auto; margin-top: 0; padding: 12px 24px; background: #dc2626;" onclick="deleteAllHistory()">
                            <i class="bi bi-trash-fill"></i>
                            <span>Delete All</span>
                        </button>
                        <button class="execute-button" style="width: auto; margin-top: 0; padding: 12px 24px;" onclick="loadHistory()">
                            <i class="bi bi-arrow-clockwise"></i>
                            <span>Refresh</span>
                        </button>
                    </div>

                    <div id="historyList">
                        <div style="text-align: center; color: #555555; padding: 60px 0;">No tests executed yet</div>
                    </div>
                </div>

                <div id="configurationView" class="hidden">
                    <div class="page-header">
                        <h1 class="page-title">Configuration</h1>
                        <p class="page-subtitle">Set up your local agent and configure automation settings</p>
                    </div>

                    <div class="result-panel" style="margin-bottom: 24px;">
                        <div class="panel-title">System Information</div>
                        <div style="padding: 20px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px;">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                                <div>
                                    <div style="font-size: 12px; color: #888888; margin-bottom: 6px;">Operating System</div>
                                    <div style="font-size: 15px; font-weight: 600; color: #ffffff;" id="detectedOS">Detecting...</div>
                                </div>
                                <div>
                                    <div style="font-size: 12px; color: #888888; margin-bottom: 6px;">Browser</div>
                                    <div style="font-size: 15px; font-weight: 600; color: #ffffff;" id="detectedBrowser">Detecting...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="result-panel">
                        <div class="panel-title">Local Agent Setup</div>
                        <div style="padding: 24px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px;">
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 14px; font-weight: 600; color: #ffffff; margin-bottom: 8px;">
                                    <i class="bi bi-info-circle" style="color: #8b5cf6;"></i> About Local Agent
                                </div>
                                <div style="font-size: 13px; color: #888888; line-height: 1.6;">
                                    The local agent allows you to run browser automations in headful mode on your machine. 
                                    It connects to this server and executes tests with a visible browser window, perfect for debugging and development.
                                </div>
                            </div>

                            <div style="background: #0f0f0f; border: 1px solid #1f1f1f; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                                <div style="font-size: 13px; font-weight: 600; color: #cccccc; margin-bottom: 12px;">Download Agent for Your System</div>
                                <a href="/api/agent/download" class="execute-button" style="text-decoration: none; width: auto; display: inline-flex; margin-top: 0;">
                                    <i class="bi bi-download"></i>
                                    <span>Download Local Agent (Python Script)</span>
                                </a>
                            </div>

                            <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 10px; padding: 16px;">
                                <div style="font-size: 13px; font-weight: 600; color: #ffffff; margin-bottom: 12px;">
                                    <i class="bi bi-terminal"></i> Setup Instructions
                                </div>
                                <ol style="font-size: 13px; color: #cccccc; line-height: 1.8; padding-left: 20px; margin: 0;">
                                    <li>Download the agent script using the button above</li>
                                    <li>Ensure Python 3.7+ is installed on your system</li>
                                    <li>Install required packages: <code style="background: #0f0f0f; padding: 2px 8px; border-radius: 4px; color: #10b981;">pip install playwright python-socketio websocket-client</code></li>
                                    <li>Install Playwright browsers: <code style="background: #0f0f0f; padding: 2px 8px; border-radius: 4px; color: #10b981;">playwright install</code></li>
                                    <li>Set the server URL environment variable:<br>
                                        <div style="margin-top: 8px; background: #0f0f0f; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 11px; color: #10b981; word-break: break-all;" id="serverUrlCommand">Loading...</div>
                                    </li>
                                    <li>Run the agent: <code style="background: #0f0f0f; padding: 2px 8px; border-radius: 4px; color: #10b981;">python local_agent.py</code></li>
                                    <li>The agent will connect automatically to this server</li>
                                </ol>
                            </div>

                            <div style="margin-top: 20px; font-size: 12px; color: #666666;">
                                <i class="bi bi-shield-check"></i> The agent connects securely via WebSocket and only executes code generated by this server.
                            </div>
                        </div>
                    </div>

                    <div class="result-panel" style="margin-top: 24px;">
                        <div class="panel-title">API Configuration</div>
                        <div style="padding: 20px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px;">
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 13px; color: #888888; margin-bottom: 8px;">OpenAI API Key</div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 14px; font-weight: 600; color: #10b981;" id="apiKeyStatus">
                                        <i class="bi bi-check-circle-fill"></i> Configured
                                    </span>
                                </div>
                            </div>
                            <div style="font-size: 12px; color: #666666;">
                                API key is securely stored in environment variables and used for generating automation scripts.
                            </div>
                        </div>
                    </div>
                </div>

                <div id="teachingModeView" class="hidden">
                    <div class="page-header">
                        <h1 class="page-title">Teaching Mode</h1>
                        <p class="page-subtitle">Record browser actions and teach VisionVault new automation tasks</p>
                    </div>

                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">
                        <div>
                            <div class="result-panel" style="margin-bottom: 20px;">
                                <div class="panel-title">
                                    <i class="bi bi-camera-video-fill"></i> Recording Controls
                                </div>
                                <div style="padding: 24px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px;">
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: block; font-size: 13px; font-weight: 600; color: #cccccc; margin-bottom: 8px;">
                                            <i class="bi bi-globe"></i> Start URL (Optional)
                                        </label>
                                        <input type="url" id="recordingStartUrl" placeholder="https://example.com (leave blank for empty browser)" style="width: 100%; background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 8px; padding: 12px 16px; color: #ffffff; font-size: 14px;">
                                        <div style="font-size: 11px; color: #666666; margin-top: 6px;">
                                            <i class="bi bi-info-circle"></i> Enter a URL to start recording on a specific page, or leave blank to navigate manually
                                        </div>
                                    </div>

                                    <div id="recordingStatus" style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding: 16px; background: #0f0f0f; border: 1px solid #1f1f1f; border-radius: 8px;">
                                        <div style="width: 12px; height: 12px; background: #555555; border-radius: 50%; animation: pulse 2s infinite;"></div>
                                        <span style="font-size: 14px; font-weight: 600; color: #888888;">Ready to Record</span>
                                    </div>

                                    <div style="display: flex; gap: 12px;">
                                        <button id="startRecordingBtn" class="execute-button" style="flex: 1; margin-top: 0;" onclick="startRecording()">
                                            <i class="bi bi-record-circle"></i>
                                            <span>Start Recording</span>
                                        </button>
                                        <button id="stopRecordingBtn" class="execute-button" style="flex: 1; margin-top: 0; background: #dc2626; display: none;" onclick="stopRecording()">
                                            <i class="bi bi-stop-circle"></i>
                                            <span>Stop Recording</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="result-panel">
                                <div class="panel-title">
                                    <i class="bi bi-list-check"></i> Recorded Actions
                                    <span id="actionCount" style="float: right; font-size: 12px; color: #8b5cf6; font-weight: 600;">0 actions</span>
                                </div>
                                <div id="recordedActions" style="padding: 16px; background: #0f0f0f; border: 1px solid #1f1f1f; border-radius: 8px; min-height: 300px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; color: #e2e8f0;">
                                    <div style="text-align: center; color: #555555; padding: 40px 0;">No actions recorded yet</div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <div class="result-panel">
                                <div class="panel-title">
                                    <i class="bi bi-save-fill"></i> Save Task
                                </div>
                                <div style="padding: 20px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px;">
                                    <form id="saveTaskForm" onsubmit="saveLearnedTask(event)">
                                        <div style="margin-bottom: 16px;">
                                            <label style="display: block; font-size: 13px; font-weight: 600; color: #cccccc; margin-bottom: 8px;">Task Name</label>
                                            <input type="text" id="taskName" required style="width: 100%; background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 8px; padding: 10px 12px; color: #ffffff; font-size: 13px;" placeholder="e.g., Login to Gmail">
                                        </div>

                                        <div style="margin-bottom: 16px;">
                                            <label style="display: block; font-size: 13px; font-weight: 600; color: #cccccc; margin-bottom: 8px;">Description</label>
                                            <textarea id="taskDescription" rows="3" style="width: 100%; background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 8px; padding: 10px 12px; color: #ffffff; font-size: 13px; resize: vertical;" placeholder="Describe what this task does..."></textarea>
                                        </div>

                                        <div style="margin-bottom: 20px;">
                                            <label style="display: block; font-size: 13px; font-weight: 600; color: #cccccc; margin-bottom: 8px;">Tags</label>
                                            <input type="text" id="taskTags" style="width: 100%; background: #0f0f0f; border: 1px solid #2a2a2a; border-radius: 8px; padding: 10px 12px; color: #ffffff; font-size: 13px;" placeholder="login, gmail, email (comma separated)">
                                        </div>

                                        <button type="submit" class="execute-button" style="margin-top: 0; width: 100%;" disabled id="saveTaskBtn">
                                            <i class="bi bi-cloud-arrow-up"></i>
                                            <span>Save to Memory</span>
                                        </button>
                                    </form>

                                    <div id="saveSuccess" class="hidden" style="margin-top: 16px; padding: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; color: #10b981; font-size: 13px; text-align: center;">
                                        <i class="bi bi-check-circle-fill"></i> Task saved successfully!
                                    </div>
                                </div>
                            </div>

                            <div class="result-panel" style="margin-top: 20px;">
                                <div class="panel-title">
                                    <i class="bi bi-exclamation-triangle-fill"></i> Local Agent Required
                                </div>
                                <div style="padding: 20px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 12px;">
                                    <div style="font-size: 14px; font-weight: 600; color: #f59e0b; margin-bottom: 12px;">
                                        <i class="bi bi-info-circle-fill"></i> Teaching Mode requires the Local Agent
                                    </div>
                                    <div style="font-size: 13px; color: #d97706; line-height: 1.6; margin-bottom: 16px;">
                                        Since this app runs in the cloud, we can't open GUI browsers on the server. To use Teaching Mode, you need to run the Local Agent on your computer where it can open a real browser window.
                                    </div>
                                    <a href="/api/agent/download" download class="execute-button" style="margin-top: 0; width: 100%; text-decoration: none; display: inline-flex; background: #f59e0b; justify-content: center;">
                                        <i class="bi bi-download"></i>
                                        <span>Download Local Agent</span>
                                    </a>
                                </div>
                            </div>
                            
                            <div class="result-panel" style="margin-top: 20px;">
                                <div class="panel-title">
                                    <i class="bi bi-list-check"></i> How It Works
                                </div>
                                <div style="padding: 16px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px; font-size: 13px; color: #888888; line-height: 1.6;">
                                    <ol style="padding-left: 20px; margin: 0;">
                                        <li style="margin-bottom: 8px;">Download and run the Local Agent on your computer</li>
                                        <li style="margin-bottom: 8px;">Click "Start Recording" in Teaching Mode</li>
                                        <li style="margin-bottom: 8px;">A browser will open on YOUR computer</li>
                                        <li style="margin-bottom: 8px;">Perform actions - they're automatically recorded</li>
                                        <li style="margin-bottom: 8px;">Click "Stop Recording" when done</li>
                                        <li style="margin-bottom: 8px;">Name, describe, and tag your task</li>
                                        <li>Save to memory for future AI-powered recall</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="taskLibraryView" class="hidden">
                    <div class="page-header">
                        <h1 class="page-title">Task Library</h1>
                        <p class="page-subtitle">Manage your learned automation tasks</p>
                    </div>

                    <div style="margin-bottom: 24px; display: flex; gap: 12px; align-items: center;">
                        <div style="flex: 1;">
                            <input type="text" id="taskSearchInput" oninput="filterTasks()" style="width: 100%; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 10px; padding: 12px 16px 12px 44px; color: #ffffff; font-size: 14px; background-image: url('data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 fill=%22%238b5cf6%22 viewBox=%220 0 16 16%22%3E%3Cpath d=%22M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z%22/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: 16px center; background-size: 16px;" placeholder="Search tasks by name, description, or tags...">
                        </div>
                        <button class="execute-button" style="width: auto; margin-top: 0; padding: 12px 24px;" onclick="loadTaskLibrary()">
                            <i class="bi bi-arrow-clockwise"></i>
                            <span>Refresh</span>
                        </button>
                    </div>

                    <div id="taskStats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                        <div style="background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px; padding: 20px;">
                            <div style="font-size: 12px; color: #888888; margin-bottom: 6px;">Total Tasks</div>
                            <div style="font-size: 24px; font-weight: 700; color: #8b5cf6;" id="totalTasks">0</div>
                        </div>
                        <div style="background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px; padding: 20px;">
                            <div style="font-size: 12px; color: #888888; margin-bottom: 6px;">Successful Runs</div>
                            <div style="font-size: 24px; font-weight: 700; color: #10b981;" id="successfulRuns">0</div>
                        </div>
                        <div style="background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px; padding: 20px;">
                            <div style="font-size: 12px; color: #888888; margin-bottom: 6px;">Failed Runs</div>
                            <div style="font-size: 24px; font-weight: 700; color: #dc2626;" id="failedRuns">0</div>
                        </div>
                        <div style="background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px; padding: 20px;">
                            <div style="font-size: 12px; color: #888888; margin-bottom: 6px;">Success Rate</div>
                            <div style="font-size: 24px; font-weight: 700; color: #8b5cf6;" id="successRate">0%</div>
                        </div>
                    </div>

                    <div id="taskLibraryContent" style="display: grid; gap: 16px;">
                        <div style="text-align: center; color: #555555; padding: 60px 0;">Loading tasks...</div>
                    </div>
                </div>

                <div id="scriptsLibraryView" class="hidden">
                    <div class="page-header">
                        <h1 class="page-title">Scripts Library</h1>
                        <p class="page-subtitle">Browse, download, and run your generated automation scripts</p>
                    </div>

                    <div style="display: flex; gap: 12px; margin-bottom: 24px; align-items: center;">
                        <input type="text" id="scriptSearchInput" oninput="filterScripts()" style="flex: 1; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 10px; padding: 12px 16px 12px 44px; color: #ffffff; font-size: 14px; background-image: url('data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 fill=%22%238b5cf6%22 viewBox=%220 0 16 16%22%3E%3Cpath d=%22M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z%22/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: 16px center; background-size: 16px;" placeholder="Search scripts by name or description...">
                        <button class="execute-button" style="width: auto; margin-top: 0; padding: 12px 24px;" onclick="loadScriptsLibrary()">
                            <i class="bi bi-arrow-clockwise"></i>
                            <span>Refresh</span>
                        </button>
                    </div>

                    <div id="scriptsStats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
                        <div style="background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px; padding: 20px;">
                            <div style="font-size: 12px; color: #888888; margin-bottom: 6px;">Total Scripts</div>
                            <div style="font-size: 24px; font-weight: 700; color: #8b5cf6;" id="totalScripts">0</div>
                        </div>
                        <div style="background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px; padding: 20px;">
                            <div style="font-size: 12px; color: #888888; margin-bottom: 6px;">Healed Scripts</div>
                            <div style="font-size: 24px; font-weight: 700; color: #10b981;" id="healedScripts">0</div>
                        </div>
                        <div style="background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px; padding: 20px;">
                            <div style="font-size: 12px; color: #888888; margin-bottom: 6px;">From Tasks</div>
                            <div style="font-size: 24px; font-weight: 700; color: #f59e0b;" id="taskScripts">0</div>
                        </div>
                    </div>

                    <div id="scriptsContent" style="display: grid; gap: 16px;">
                        <div style="text-align: center; color: #555555; padding: 60px 0;">Loading scripts...</div>
                    </div>
                </div>

                <div id="recallModeView" class="hidden">
                    <div class="page-header">
                        <h1 class="page-title">Recall Mode</h1>
                        <p class="page-subtitle">Find and execute tasks using natural language</p>
                    </div>

                    <div class="result-panel" style="margin-bottom: 24px;">
                        <div class="panel-title">
                            <i class="bi bi-search"></i> Search Tasks
                        </div>
                        <div style="padding: 24px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px;">
                            <div class="form-section" style="margin-bottom: 0;">
                                <label class="form-label">What do you want to do?</label>
                                <textarea class="prompt-input" id="recallQuery" placeholder="Describe the task in natural language...

Example: Login to my email account
Example: Fill out a contact form with test data
Example: Search for products on an e-commerce site" style="min-height: 100px;"></textarea>
                                <div class="hint-text" style="justify-content: space-between;">
                                    <span><i class="bi bi-lightbulb"></i> AI will find the most similar tasks from your library</span>
                                    <span id="recallCharCount">0 characters</span>
                                </div>
                            </div>

                            <div style="display: flex; gap: 12px; margin-top: 20px;">
                                <button class="execute-button" style="flex: 1; margin-top: 0;" onclick="searchTasks()">
                                    <i class="bi bi-search"></i>
                                    <span>Search Tasks</span>
                                </button>
                                <button class="execute-button" style="flex: 1; margin-top: 0; background: #10b981;" onclick="recallAndExecute()">
                                    <i class="bi bi-lightning-charge-fill"></i>
                                    <span>Search & Execute</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="recallResults" class="hidden">
                        <div class="result-panel">
                            <div class="panel-title">
                                <i class="bi bi-list-stars"></i> Matching Tasks
                                <span id="matchCount" style="float: right; font-size: 12px; color: #8b5cf6; font-weight: 600;">0 matches</span>
                            </div>
                            <div id="recallResultsContent" style="padding: 16px; background: #0f0f0f; border: 1px solid #1f1f1f; border-radius: 8px;">
                                <div style="text-align: center; color: #555555; padding: 40px 0;">No results yet</div>
                            </div>
                        </div>
                    </div>

                    <div class="result-panel" style="margin-top: 24px;">
                        <div class="panel-title">
                            <i class="bi bi-info-circle"></i> How Recall Works
                        </div>
                        <div style="padding: 20px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px; font-size: 13px; color: #888888; line-height: 1.8;">
                            <ul style="padding-left: 20px; margin: 0;">
                                <li style="margin-bottom: 10px;"><strong style="color: #ffffff;">Semantic Search:</strong> Describes your task in natural language, and AI finds the most similar tasks from your library using vector embeddings.</li>
                                <li style="margin-bottom: 10px;"><strong style="color: #ffffff;">Similarity Scores:</strong> Each result shows a similarity score (0-100%) indicating how well it matches your query.</li>
                                <li style="margin-bottom: 10px;"><strong style="color: #ffffff;">Quick Execution:</strong> Use "Search & Execute" to automatically run the best matching task.</li>
                                <li><strong style="color: #ffffff;">Continuous Learning:</strong> The system learns from each execution to improve future recommendations.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Element Selector Widget -->
    <div id="elementSelectorWidget" class="element-selector-widget hidden">
        <div class="widget-header">
            <i class="bi bi-hand-index"></i>
            <span>Select Element</span>
            <i class="bi bi-arrows-move" style="margin-left: auto; font-size: 14px;"></i>
        </div>
        <div class="widget-body">
            <p id="selectorMessage" class="widget-message">
                Locator failed. Please click the correct element in the browser window.
            </p>
            <div class="widget-status">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <span>Execution paused - waiting for your input</span>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const socket = io();
        let currentTestId = null;
        let agentConnected = false;
        let currentMode = 'headless';
        // Unified engine auto-selects strategy - no manual selection needed

        // Theme toggle functionality
        function toggleTheme() {
            const html = document.documentElement;
            const themeToggle = document.getElementById('themeToggle');
            const icon = themeToggle.querySelector('i');
            
            if (html.classList.contains('light-theme')) {
                html.classList.remove('light-theme');
                icon.className = 'bi bi-moon-stars-fill';
                localStorage.setItem('theme', 'dark');
            } else {
                html.classList.add('light-theme');
                icon.className = 'bi bi-sun-fill';
                localStorage.setItem('theme', 'light');
            }
        }

        // Load saved theme on page load
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const html = document.documentElement;
            const themeToggle = document.getElementById('themeToggle');
            
            if (savedTheme === 'light') {
                html.classList.add('light-theme');
                if (themeToggle) {
                    const icon = themeToggle.querySelector('i');
                    if (icon) icon.className = 'bi bi-sun-fill';
                }
            }
        })();

        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('disconnect', () => {
            agentConnected = false;
            updateAgentStatus();
            updateExecuteButton();
            updateRecordingButton();
        });

        socket.on('agents_update', (data) => {
            console.log('Received agents_update:', data);
            agentConnected = data.agents.length > 0;
            updateAgentStatus();
            updateExecuteButton();
            updateRecordingButton();
        });

        socket.on('execution_status', (data) => {
            if (data.test_id === currentTestId) {
                document.getElementById('statusAlert').classList.remove('hidden');
                document.getElementById('statusMessage').textContent = data.message;
            }
        });

        socket.on('execution_complete', (data) => {
            if (data.test_id === currentTestId) {
                document.getElementById('statusAlert').classList.add('hidden');
                displayResult(data);
                loadHistory();
            }
        });

        socket.on('script_healed', (data) => {
            if (data.test_id === currentTestId) {
                displayHealedScript(data.healed_script);
                console.log('Script healed:', data);
            }
        });

        socket.on('healing_required', (data) => {
            if (data.test_id === currentTestId) {
                console.log('Healing required:', data);
                document.getElementById('statusMessage').textContent = `Locator failed: ${data.failed_locator}. AI is improving...`;
            }
        });

        socket.on('task_auto_saved', (data) => {
            if (data.test_id === currentTestId) {
                console.log('Task auto-saved:', data);
                // Show success notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: rgba(34, 197, 94, 0.95);
                    color: white;
                    padding: 16px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                    z-index: 10000;
                    font-size: 14px;
                    animation: slideIn 0.3s ease-out;
                `;
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="bi bi-check-circle-fill" style="font-size: 20px;"></i>
                        <div>
                            <div style="font-weight: 600;">Task Saved to Library!</div>
                            <div style="font-size: 12px; opacity: 0.9; margin-top: 2px;">
                                ${data.was_healed ? 'ðŸ”§ ' : ''}${data.task_name.substring(0, 50)}${data.task_name.length > 50 ? '...' : ''}
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(notification);
                
                // Auto-remove after 4 seconds
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => notification.remove(), 300);
                }, 4000);
            }
        });

        function updateAgentStatus() {
            const badge = document.getElementById('connectedBadge');
            if (agentConnected) {
                badge.className = 'connected-badge';
                badge.innerHTML = '<i class="bi bi-wifi"></i><span>Agent Connected</span>';
            } else {
                badge.className = 'connected-badge disconnected';
                badge.innerHTML = '<i class="bi bi-wifi-off"></i><span>Disconnected</span>';
            }
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('headlessBtn').classList.toggle('active', mode === 'headless');
            document.getElementById('headfulBtn').classList.toggle('active', mode === 'headful');
            updateExecuteButton();
        }

        // Removed: Engine selection now automatic via UnifiedAutomationEngine

        function updateExecuteButton() {
            const executeButton = document.getElementById('executeButton');
            if (currentMode === 'headful' && !agentConnected) {
                executeButton.disabled = true;
                executeButton.innerHTML = '<i class="bi bi-exclamation-triangle"></i><span>Agent Required for Headful Mode</span>';
            } else {
                executeButton.disabled = false;
                executeButton.innerHTML = '<i class="bi bi-play-fill"></i><span>Execute Automation</span>';
            }
        }

        function updateRecordingButton() {
            const recordingButton = document.getElementById('startRecordingBtn');
            if (recordingButton) {
                if (!agentConnected) {
                    recordingButton.disabled = true;
                    recordingButton.innerHTML = '<i class="bi bi-exclamation-triangle"></i><span>Agent Required</span>';
                    recordingButton.title = 'Connect a local agent to start recording';
                } else {
                    recordingButton.disabled = false;
                    recordingButton.innerHTML = '<i class="bi bi-record-circle"></i><span>Start Recording</span>';
                    recordingButton.title = '';
                }
            }
        }

        document.getElementById('commandInput').addEventListener('input', function() {
            document.getElementById('charCount').textContent = this.value.length + ' characters';
        });

        document.getElementById('commandInput').addEventListener('keydown', function(e) {
            if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                executeTest();
            }
        });

        function executeTest() {
            const command = document.getElementById('commandInput').value.trim();
            const browser = 'chromium';
            const mode = currentMode;
            const location = mode === 'headless' ? 'server' : 'agent';

            if (!command) {
                alert('Please enter a command');
                return;
            }

            if (mode === 'headful' && !agentConnected) {
                alert('Headful mode requires a local agent connection. Please run the agent first.');
                return;
            }

            document.getElementById('statusAlert').classList.remove('hidden');
            document.getElementById('statusMessage').textContent = currentHistoryId ? 'Re-executing from history...' : 'ðŸŽ¯ Analyzing task and selecting best automation strategy...';
            document.getElementById('scriptPanel').innerHTML = '<div class="empty-state">Generating...</div>';
            
            // Reset healed script panel and hide it
            const healedPanel = document.getElementById('healedScriptPanel');
            healedPanel.innerHTML = '<div class="empty-state">No healed script yet</div>';
            healedPanel.closest('.result-panel').style.display = 'none';
            currentGeneratedScript = '';  // Reset stored script
            
            document.getElementById('logsPanel').innerHTML = '<div class="empty-state">Waiting...</div>';

            const apiUrl = currentHistoryId ? `/api/history/rerun/${currentHistoryId}` : '/api/execute';
            const requestBody = currentHistoryId 
                ? { use_healing: true, auto_save: true }
                : { 
                    command, 
                    browser, 
                    mode, 
                    execution_location: location, 
                    auto_save: true 
                };

            fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    document.getElementById('statusAlert').classList.add('hidden');
                    document.getElementById('scriptPanel').innerHTML = '<div class="empty-state">No script generated yet</div>';
                    document.getElementById('logsPanel').innerHTML = '<div class="empty-state">No logs yet</div>';
                    return;
                }
                
                currentTestId = data.test_id;
                
                if (data.code_source === 'healed' || data.code_source === 'generated') {
                    document.getElementById('scriptPanel').innerHTML = `<div class="code-block">${data.code}</div>`;
                    currentGeneratedScript = data.code;  // Store generated script for comparison
                }
                
                currentHistoryId = null;
                const commandInput = document.getElementById('commandInput');
                commandInput.readOnly = false;
                commandInput.style.backgroundColor = '';
                commandInput.style.cursor = '';
                
                currentTestId = data.test_id;
                
                document.getElementById('scriptPanel').innerHTML = `<div class="code-block">${data.code}</div>`;
                currentGeneratedScript = data.code;  // Store generated script for comparison
                document.getElementById('statusMessage').textContent = 'Executing test...';
            })
            .catch(error => {
                alert('Error: ' + error.message);
                document.getElementById('statusAlert').classList.add('hidden');
                document.getElementById('scriptPanel').innerHTML = '<div class="empty-state">No script generated yet</div>';
                document.getElementById('logsPanel').innerHTML = '<div class="empty-state">No logs yet</div>';
            });
        }

        let currentGeneratedScript = '';
        
        function displayHealedScript(healedScript, generatedScript = null) {
            // Update generated script if provided
            if (generatedScript) {
                currentGeneratedScript = generatedScript;
            }
            
            const healedPanel = document.getElementById('healedScriptPanel');
            
            // Hide if healed script is null, empty, or same as generated
            if (!healedScript || healedScript.trim() === '' || 
                (currentGeneratedScript && healedScript.trim() === currentGeneratedScript.trim())) {
                healedPanel.innerHTML = '<div class="empty-state">No healed script yet</div>';
                healedPanel.closest('.result-panel').style.display = 'none';
            } else {
                healedPanel.innerHTML = `<div class="code-block">${healedScript}</div>`;
                healedPanel.closest('.result-panel').style.display = 'block';
            }
        }

        function displayResult(data) {
            const logsHtml = data.logs.map(log => `<div class="log-line">${log}</div>`).join('');
            document.getElementById('logsPanel').innerHTML = `<div class="log-container">${logsHtml || '<div style="color: #555555;">No logs available</div>'}</div>`;
            
            if (data.healed_script) {
                displayHealedScript(data.healed_script);
            }
            
            if (data.screenshot_path) {
                document.getElementById('screenshotPanel').innerHTML = `
                    <div class="screenshot-container">
                        <img src="/uploads/${data.screenshot_path}" alt="Screenshot" style="max-width: 100%; height: auto;">
                    </div>
                `;
            } else {
                document.getElementById('screenshotPanel').innerHTML = '<div class="empty-state">No screenshot available</div>';
            }
        }

        function loadHistory() {
            fetch('/api/history')
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        document.getElementById('historyList').innerHTML = '<div style="text-align: center; color: #555555; padding: 60px 0;">No tests executed yet</div>';
                        return;
                    }

                    const historyHtml = data.map(item => {
                        const statusClass = `status-${item.status}`;
                        return `
                            <div class="history-item" style="display: flex; align-items: center; gap: 16px;">
                                <div style="flex: 1; cursor: pointer;" onclick='showHistoryItem(${JSON.stringify(item).replace(/'/g, "&#39;")})'>
                                    <div class="history-header">
                                        <span class="status-badge ${statusClass}">${item.status}</span>
                                        <span style="color: #666666; font-size: 12px;">${new Date(item.created_at).toLocaleString()}</span>
                                    </div>
                                    <div style="font-weight: 600; margin-bottom: 8px; color: #ffffff; font-size: 14px;">${item.command}</div>
                                    <div style="color: #888888; font-size: 12px;">
                                        <i class="bi bi-browser-chrome"></i> ${item.browser} | 
                                        <i class="bi bi-eye${item.mode === 'headless' ? '-slash' : ''}"></i> ${item.mode} | 
                                        <i class="bi bi-${item.execution_location === 'server' ? 'cloud' : 'pc-display'}"></i> ${item.execution_location}
                                    </div>
                                </div>
                                <button onclick="event.stopPropagation(); deleteHistoryItem(${item.id})" style="background: #dc2626; border: none; color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.background='#b91c1c'" onmouseout="this.style.background='#dc2626'">
                                    <i class="bi bi-trash-fill"></i>
                                    <span>Delete</span>
                                </button>
                            </div>
                        `;
                    }).join('');

                    document.getElementById('historyList').innerHTML = historyHtml;
                })
                .catch(error => console.error('Error loading history:', error));
        }

        let currentHistoryId = null;

        function showHistoryItem(item) {
            showDashboard();
            
            currentHistoryId = item.id;
            
            const commandInput = document.getElementById('commandInput');
            commandInput.value = item.command;
            commandInput.readOnly = true;
            commandInput.style.backgroundColor = '#1a1a1a';
            commandInput.style.cursor = 'not-allowed';
            
            const codeToDisplay = item.healed_code || item.generated_code;
            document.getElementById('scriptPanel').innerHTML = `<div class="code-block">${codeToDisplay}</div>`;
            
            const logs = item.logs ? JSON.parse(item.logs) : [];
            const logsHtml = logs.map(log => `<div class="log-line">${log}</div>`).join('');
            document.getElementById('logsPanel').innerHTML = `<div class="log-container">${logsHtml || '<div style="color: #555555;">No logs available</div>'}</div>`;
            
            if (item.screenshot_path) {
                document.getElementById('screenshotPanel').innerHTML = `
                    <div class="screenshot-container">
                        <img src="/uploads/${item.screenshot_path}" alt="Screenshot" style="max-width: 100%; height: auto;">
                    </div>
                `;
            } else {
                document.getElementById('screenshotPanel').innerHTML = '<div class="empty-state">No screenshot available</div>';
            }
            
            if (item.healed_code) {
                displayHealedScript(item.healed_code);
            }
        }

        async function deleteHistoryItem(id) {
            if (!confirm('Are you sure you want to delete this history item?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/history/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadHistory();
                } else {
                    alert('Failed to delete history item');
                }
            } catch (error) {
                console.error('Error deleting history item:', error);
                alert('Error deleting history item');
            }
        }

        async function deleteAllHistory() {
            if (!confirm('Are you sure you want to delete ALL history? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/history/all', {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadHistory();
                } else {
                    alert('Failed to delete all history');
                }
            } catch (error) {
                console.error('Error deleting all history:', error);
                alert('Error deleting all history');
            }
        }

        function showDashboard() {
            document.getElementById('dashboardView').classList.remove('hidden');
            document.getElementById('historyView').classList.add('hidden');
            document.getElementById('configurationView').classList.add('hidden');
            document.getElementById('scriptsLibraryView').classList.add('hidden');
            document.getElementById('teachingModeView').classList.add('hidden');
            document.getElementById('taskLibraryView').classList.add('hidden');
            document.getElementById('recallModeView').classList.add('hidden');
            
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelectorAll('.nav-link')[0].classList.add('active');
            
            if (!currentHistoryId) {
                const commandInput = document.getElementById('commandInput');
                commandInput.value = '';
                commandInput.readOnly = false;
                commandInput.style.backgroundColor = '';
                commandInput.style.cursor = '';
            }
        }

        function showHistory() {
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('historyView').classList.remove('hidden');
            document.getElementById('configurationView').classList.add('hidden');
            document.getElementById('scriptsLibraryView').classList.add('hidden');
            document.getElementById('teachingModeView').classList.add('hidden');
            document.getElementById('taskLibraryView').classList.add('hidden');
            document.getElementById('recallModeView').classList.add('hidden');
            
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelectorAll('.nav-link')[1].classList.add('active');
            
            loadHistory();
        }

        function showConfiguration() {
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('historyView').classList.add('hidden');
            document.getElementById('configurationView').classList.remove('hidden');
            document.getElementById('scriptsLibraryView').classList.add('hidden');
            document.getElementById('teachingModeView').classList.add('hidden');
            document.getElementById('taskLibraryView').classList.add('hidden');
            document.getElementById('recallModeView').classList.add('hidden');
            
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.querySelectorAll('.nav-link')[2].classList.add('active');
            
            detectSystemInfo();
        }

        function showTeachingMode() {
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('historyView').classList.add('hidden');
            document.getElementById('configurationView').classList.add('hidden');
            document.getElementById('scriptsLibraryView').classList.add('hidden');
            document.getElementById('teachingModeView').classList.remove('hidden');
            document.getElementById('taskLibraryView').classList.add('hidden');
            document.getElementById('recallModeView').classList.add('hidden');
            
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        }

        function showTaskLibrary() {
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('historyView').classList.add('hidden');
            document.getElementById('configurationView').classList.add('hidden');
            document.getElementById('scriptsLibraryView').classList.add('hidden');
            document.getElementById('teachingModeView').classList.add('hidden');
            document.getElementById('taskLibraryView').classList.remove('hidden');
            document.getElementById('recallModeView').classList.add('hidden');
            
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            
            loadTaskLibrary();
        }

        function showRecallMode() {
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('historyView').classList.add('hidden');
            document.getElementById('configurationView').classList.add('hidden');
            document.getElementById('scriptsLibraryView').classList.add('hidden');
            document.getElementById('teachingModeView').classList.add('hidden');
            document.getElementById('taskLibraryView').classList.add('hidden');
            document.getElementById('recallModeView').classList.remove('hidden');
            
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        }

        function detectSystemInfo() {
            const userAgent = navigator.userAgent;
            const platform = navigator.platform;
            
            let os = 'Unknown OS';
            if (platform.indexOf('Win') !== -1) os = 'Windows';
            else if (platform.indexOf('Mac') !== -1) os = 'macOS';
            else if (platform.indexOf('Linux') !== -1) os = 'Linux';
            else if (platform.indexOf('iPhone') !== -1 || platform.indexOf('iPad') !== -1) os = 'iOS';
            else if (userAgent.indexOf('Android') !== -1) os = 'Android';
            
            let browser = 'Unknown Browser';
            if (userAgent.indexOf('Chrome') !== -1 && userAgent.indexOf('Edg') === -1) browser = 'Google Chrome';
            else if (userAgent.indexOf('Safari') !== -1 && userAgent.indexOf('Chrome') === -1) browser = 'Safari';
            else if (userAgent.indexOf('Firefox') !== -1) browser = 'Mozilla Firefox';
            else if (userAgent.indexOf('Edg') !== -1) browser = 'Microsoft Edge';
            else if (userAgent.indexOf('Opera') !== -1 || userAgent.indexOf('OPR') !== -1) browser = 'Opera';
            
            document.getElementById('detectedOS').textContent = os;
            document.getElementById('detectedBrowser').textContent = browser;
            
            const serverUrl = window.location.origin;
            const isWindows = os === 'Windows';
            
            if (isWindows) {
                document.getElementById('serverUrlCommand').textContent = `set AGENT_SERVER_URL=${serverUrl}`;
            } else {
                document.getElementById('serverUrlCommand').textContent = `export AGENT_SERVER_URL=${serverUrl}`;
            }
        }

        socket.on('element_selector_needed', (data) => {
            if (data.test_id === currentTestId && currentMode === 'headful') {
                console.log('Element selector needed:', data);
                showElementSelectorWidget(data);
            }
        });

        function showElementSelectorWidget(data) {
            const widget = document.getElementById('elementSelectorWidget');
            const message = document.getElementById('selectorMessage');
            const failedStep = data.failed_step || 'Unknown';
            const failedLocator = data.failed_locator || 'Unknown locator';
            message.textContent = `Step ${failedStep} failed with locator: "${failedLocator}". Please click the correct element in the browser window.`;
            widget.classList.remove('hidden');
            
            document.getElementById('statusMessage').textContent = `Waiting for element selection... Step ${failedStep}: ${failedLocator}`;
        }

        function hideElementSelectorWidget() {
            document.getElementById('elementSelectorWidget').classList.add('hidden');
        }

        socket.on('element_selected_confirmed', (data) => {
            if (data.test_id === currentTestId) {
                hideElementSelectorWidget();
                document.getElementById('statusMessage').textContent = 'Healing script and continuing execution...';
                
                if (data.healed_script) {
                    displayHealedScript(data.healed_script);
                }
            }
        });

        function makeDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            let isDragging = false;
            const header = element.querySelector('.widget-header');
            
            if (header) {
                header.style.cursor = 'move';
                header.onmousedown = dragMouseDown;
            }

            function dragMouseDown(e) {
                e.preventDefault();
                isDragging = true;
                
                // Remove transform and set absolute position on first drag
                if (element.style.transform !== 'none') {
                    const rect = element.getBoundingClientRect();
                    element.style.transform = 'none';
                    element.style.top = rect.top + 'px';
                    element.style.left = rect.left + 'px';
                }
                
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                if (!isDragging) return;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                isDragging = false;
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            const widget = document.getElementById('elementSelectorWidget');
            if (widget) {
                makeDraggable(widget);
            }
            // Initialize recording button state
            updateRecordingButton();
        });

        let recordedActions = [];
        let isRecording = false;
        let currentRecordingTestId = null;
        let recordingSessionId = null;
        let actionPollInterval = null;
        let generatedPlaywrightCode = null;  // Store server-generated code
        
        // Listen for recording complete event from server
        socket.on('recording_complete', (data) => {
            console.log('Recording complete:', data);
            recordedActions = data.actions || [];
            generatedPlaywrightCode = data.playwright_code || null;
            updateActionList();
            
            // Update UI to show recording is complete
            document.getElementById('startRecordingBtn').style.display = 'flex';
            document.getElementById('stopRecordingBtn').style.display = 'none';
            document.getElementById('saveTaskBtn').disabled = recordedActions.length === 0;
            
            const status = document.getElementById('recordingStatus');
            status.innerHTML = `
                <div style="width: 12px; height: 12px; background: #10b981; border-radius: 50%;"></div>
                <span style="font-size: 14px; font-weight: 600; color: #10b981;">Recording Complete - ${recordedActions.length} actions captured</span>
            `;
        });

        async function startRecording() {
            if (!agentConnected) {
                alert('Please connect a local agent before starting recording. Recording requires a local agent to capture browser actions.');
                return;
            }

            recordedActions = [];
            isRecording = true;
            
            // Get the start URL from input field
            const startUrlInput = document.getElementById('recordingStartUrl');
            const startUrl = startUrlInput ? startUrlInput.value.trim() : '';
            
            document.getElementById('startRecordingBtn').style.display = 'none';
            document.getElementById('stopRecordingBtn').style.display = 'flex';
            document.getElementById('saveTaskBtn').disabled = true;
            
            const status = document.getElementById('recordingStatus');
            status.innerHTML = `
                <div style="width: 12px; height: 12px; background: #dc2626; border-radius: 50%; animation: pulse 1s infinite;"></div>
                <span style="font-size: 14px; font-weight: 600; color: #dc2626;">Recording...</span>
            `;
            
            // Start real recording session via API
            try {
                const response = await fetch('/api/teaching/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        browser: 'chromium',
                        start_url: startUrl  // Use URL from input field or blank if empty
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    recordingSessionId = data.session_id;
                    
                    // Poll for actions every 2 seconds
                    actionPollInterval = setInterval(async () => {
                        try {
                            const actionsResponse = await fetch(`/api/teaching/actions?session_id=${recordingSessionId}`);
                            const actionsData = await actionsResponse.json();
                            if (actionsData.actions) {
                                recordedActions = actionsData.actions;
                                updateActionList();
                            }
                        } catch (error) {
                            console.error('Error polling actions:', error);
                        }
                    }, 2000);
                    
                    const urlMessage = startUrl ? `Starting at: ${startUrl}\n\n` : 'Browser opened with blank page.\n\n';
                    alert(`âœ… ${urlMessage}Perform your automation actions in the browser window.\n\nActions will be recorded automatically as you:\nâ€¢ Navigate to websites\nâ€¢ Click on elements\nâ€¢ Fill in forms\nâ€¢ Select options\n\nClick "Stop Recording" when done.`);
                } else {
                    alert('Error starting recording: ' + (data.error || 'Unknown error'));
                    isRecording = false;
                    document.getElementById('startRecordingBtn').style.display = 'flex';
                    document.getElementById('stopRecordingBtn').style.display = 'none';
                }
            } catch (error) {
                console.error('Error starting recording:', error);
                alert('Network error while starting recording');
                isRecording = false;
                document.getElementById('startRecordingBtn').style.display = 'flex';
                document.getElementById('stopRecordingBtn').style.display = 'none';
            }
        }

        async function stopRecording() {
            isRecording = false;
            
            // Stop polling
            if (actionPollInterval) {
                clearInterval(actionPollInterval);
                actionPollInterval = null;
            }
            
            // Stop recording session and get final actions
            try {
                const response = await fetch('/api/teaching/stop', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        session_id: recordingSessionId
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.actions) {
                    recordedActions = data.actions;
                    updateActionList();
                }
            } catch (error) {
                console.error('Error stopping recording:', error);
            }
            
            recordingSessionId = null;
            
            document.getElementById('startRecordingBtn').style.display = 'flex';
            document.getElementById('stopRecordingBtn').style.display = 'none';
            document.getElementById('saveTaskBtn').disabled = recordedActions.length === 0;
            
            const status = document.getElementById('recordingStatus');
            status.innerHTML = `
                <div style="width: 12px; height: 12px; background: #10b981; border-radius: 50%;"></div>
                <span style="font-size: 14px; font-weight: 600; color: #10b981;">Recording Complete - ${recordedActions.length} actions captured</span>
            `;
        }

        function updateActionList() {
            const container = document.getElementById('recordedActions');
            document.getElementById('actionCount').textContent = `${recordedActions.length} actions`;
            
            if (recordedActions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #555555; padding: 40px 0;">No actions recorded yet</div>';
                return;
            }
            
            container.innerHTML = recordedActions.map((action, index) => {
                // Support both old format (type, selector) and new format (action, target, description)
                const actionType = action.action || action.type || 'unknown';
                const target = action.target || action.selector || action.url || '';
                const value = action.value || '';
                const description = action.description || '';
                
                return `
                    <div style="margin-bottom: 8px; padding: 8px; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 6px;">
                        <span style="color: #8b5cf6; font-weight: 600;">${index + 1}.</span>
                        <span style="color: #10b981;">${actionType}</span>
                        ${description ? `<span style="color: #cccccc;"> - ${description}</span>` : ''}
                        ${!description && target ? `<span style="color: #888888;"> - ${target}</span>` : ''}
                        ${value ? `<span style="color: #888888;"> = "${value}"</span>` : ''}
                    </div>
                `;
            }).join('');
        }

        async function saveLearnedTask(event) {
            event.preventDefault();
            
            const taskName = document.getElementById('taskName').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const tags = document.getElementById('taskTags').value.split(',').map(t => t.trim()).filter(t => t);
            
            if (!taskName) {
                alert('Please enter a task name');
                return;
            }
            
            if (recordedActions.length === 0) {
                alert('No actions recorded. Please start recording first.');
                return;
            }
            
            // CRITICAL: Only use server-generated Playwright code (no placeholder/dummy code)
            if (!generatedPlaywrightCode) {
                alert('Error: Proper Playwright code not generated. Please try recording again.');
                console.error('Server-generated code is missing. This should not happen.');
                return;
            }
            
            const playwrightCode = generatedPlaywrightCode;
            
            try {
                const response = await fetch('/api/tasks/save', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        task_name: taskName,
                        description: description,
                        playwright_code: playwrightCode,
                        steps: recordedActions,
                        tags: tags
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('saveSuccess').classList.remove('hidden');
                    setTimeout(() => {
                        document.getElementById('saveSuccess').classList.add('hidden');
                    }, 3000);
                    
                    document.getElementById('saveTaskForm').reset();
                    recordedActions = [];
                    updateActionList();
                    document.getElementById('saveTaskBtn').disabled = true;
                    
                    const status = document.getElementById('recordingStatus');
                    status.innerHTML = `
                        <div style="width: 12px; height: 12px; background: #555555; border-radius: 50%; animation: pulse 2s infinite;"></div>
                        <span style="font-size: 14px; font-weight: 600; color: #888888;">Ready to Record</span>
                    `;
                } else {
                    alert('Error saving task: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving task:', error);
                alert('Network error while saving task');
            }
        }

        // Note: Playwright code generation is now handled server-side in app.py
        // The generate_playwright_code_from_recording() function creates proper,
        // executable code with browser launch, error handling, and screenshot capture.
        // We no longer use client-side code generation to prevent placeholder/dummy code.

        let allTasks = [];

        async function loadTaskLibrary() {
            try {
                const response = await fetch('/api/tasks');
                const tasks = await response.json();
                
                allTasks = tasks;
                renderTaskLibrary(tasks);
                updateTaskStats(tasks);
            } catch (error) {
                console.error('Error loading tasks:', error);
                document.getElementById('taskLibraryContent').innerHTML = `
                    <div style="text-align: center; color: #dc2626; padding: 60px 0;">
                        Error loading tasks. Please try again.
                    </div>
                `;
            }
        }

        function renderTaskLibrary(tasks) {
            const container = document.getElementById('taskLibraryContent');
            
            if (!tasks || tasks.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #555555; padding: 60px 0;">
                        <i class="bi bi-inbox" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No tasks yet</div>
                        <div style="font-size: 14px;">Go to Teaching Mode to record your first automation task</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = tasks.map(task => `
                <div class="result-panel" style="margin-bottom: 0;">
                    <div style="padding: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                            <div style="flex: 1;">
                                <h3 style="font-size: 16px; font-weight: 600; color: #ffffff; margin-bottom: 8px;">
                                    ${task.task_name}
                                </h3>
                                <p style="font-size: 13px; color: #888888; margin-bottom: 12px;">
                                    ${task.description || 'No description'}
                                </p>
                                ${task.tags && task.tags.length > 0 ? `
                                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                        ${task.tags.map(tag => `
                                            <span style="font-size: 11px; background: rgba(139, 92, 246, 0.2); color: #a78bfa; padding: 4px 10px; border-radius: 4px;">
                                                ${tag}
                                            </span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="icon-button" onclick="executeTask('${task.task_id}')" title="Execute Task">
                                    <i class="bi bi-play-fill"></i>
                                </button>
                                <button class="icon-button" onclick="viewTaskCode('${task.task_id}')" title="View Code">
                                    <i class="bi bi-code-slash"></i>
                                </button>
                                <button class="icon-button" onclick="deleteTask('${task.task_id}')" title="Delete Task">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; padding-top: 16px; border-top: 1px solid #2a2a2a;">
                            <div>
                                <div style="font-size: 11px; color: #666666; margin-bottom: 4px;">Success Rate</div>
                                <div style="font-size: 15px; font-weight: 600; color: #10b981;">
                                    ${calculateSuccessRate(task)}%
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #666666; margin-bottom: 4px;">Executions</div>
                                <div style="font-size: 15px; font-weight: 600; color: #8b5cf6;">
                                    ${(task.success_count || 0) + (task.failure_count || 0)}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #666666; margin-bottom: 4px;">Last Run</div>
                                <div style="font-size: 15px; font-weight: 600; color: #ffffff;">
                                    ${task.last_executed ? formatDate(task.last_executed) : 'Never'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateTaskStats(tasks) {
            const total = tasks.length;
            const successCount = tasks.reduce((sum, task) => sum + (task.success_count || 0), 0);
            const failureCount = tasks.reduce((sum, task) => sum + (task.failure_count || 0), 0);
            const successRate = successCount + failureCount > 0 ? Math.round((successCount / (successCount + failureCount)) * 100) : 0;
            
            document.getElementById('totalTasks').textContent = total;
            document.getElementById('successfulRuns').textContent = successCount;
            document.getElementById('failedRuns').textContent = failureCount;
            document.getElementById('successRate').textContent = successRate + '%';
        }

        function calculateSuccessRate(task) {
            const total = (task.success_count || 0) + (task.failure_count || 0);
            if (total === 0) return 0;
            return Math.round((task.success_count / total) * 100);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
            return `${Math.floor(diffMins / 1440)}d ago`;
        }

        function filterTasks() {
            const searchTerm = document.getElementById('taskSearchInput').value.toLowerCase();
            const filtered = allTasks.filter(task => {
                const nameMatch = task.task_name.toLowerCase().includes(searchTerm);
                const descMatch = (task.description || '').toLowerCase().includes(searchTerm);
                const tagsMatch = task.tags && task.tags.some(tag => tag.toLowerCase().includes(searchTerm));
                return nameMatch || descMatch || tagsMatch;
            });
            renderTaskLibrary(filtered);
        }

        async function executeTask(taskId) {
            if (!confirm('Execute this task in headless mode?')) return;
            
            try {
                const response = await fetch(`/api/tasks/${taskId}/execute`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        browser: 'chromium',
                        mode: 'headless',
                        execution_location: 'server'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Task execution started! Check the History tab for results.');
                    loadTaskLibrary();
                } else {
                    alert('Error executing task: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error executing task:', error);
                alert('Network error while executing task');
            }
        }

        async function viewTaskCode(taskId) {
            try {
                const response = await fetch(`/api/tasks/${taskId}`);
                const task = await response.json();
                
                if (response.ok) {
                    alert(`Playwright Code:\n\n${task.playwright_code}`);
                } else {
                    alert('Error loading task');
                }
            } catch (error) {
                console.error('Error loading task:', error);
            }
        }

        async function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) return;
            
            try {
                const response = await fetch(`/api/tasks/${taskId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Task deleted successfully');
                    loadTaskLibrary();
                } else {
                    alert('Error deleting task');
                }
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('Network error while deleting task');
            }
        }

        document.getElementById('recallQuery').addEventListener('input', function() {
            document.getElementById('recallCharCount').textContent = this.value.length + ' characters';
        });

        async function searchTasks() {
            const query = document.getElementById('recallQuery').value.trim();
            
            if (!query) {
                alert('Please enter a search query');
                return;
            }
            
            try {
                const response = await fetch('/api/tasks/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        query: query,
                        top_k: 5
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.results) {
                    displayRecallResults(data.results);
                } else {
                    const errorMsg = data.error || 'Unknown error';
                    if (errorMsg.includes('OPENAI_API_KEY') || errorMsg.includes('embedding')) {
                        alert('âš ï¸ Semantic search requires OpenAI API key.\n\nPlease add OPENAI_API_KEY to your Replit Secrets to enable AI-powered task search.');
                    } else {
                        alert('Error searching tasks: ' + errorMsg);
                    }
                }
            } catch (error) {
                console.error('Error searching tasks:', error);
                alert('Network error while searching tasks. Please try again.');
            }
        }

        async function recallAndExecute() {
            const query = document.getElementById('recallQuery').value.trim();
            
            if (!query) {
                alert('Please enter a search query');
                return;
            }
            
            if (!confirm('This will search for the best matching task and execute it immediately. Continue?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/tasks/recall', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        query: query,
                        auto_execute: true,
                        browser: 'chromium',
                        mode: 'headless',
                        execution_location: 'server'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    if (data.results && data.results.length > 0) {
                        displayRecallResults(data.results);
                        if (data.execution) {
                            alert(`âœ… Task "${data.results[0].task_name}" is being executed! Check the History tab for results.`);
                            loadHistory();
                        } else {
                            alert(`Best match: "${data.results[0].task_name}" (${Math.round(data.results[0].similarity_score * 100)}% match). Execute it from the results below.`);
                        }
                    } else {
                        alert('No matching tasks found. Try creating one in Teaching Mode first!');
                    }
                } else {
                    const errorMsg = data.error || 'Unknown error';
                    if (errorMsg.includes('OPENAI_API_KEY') || errorMsg.includes('embedding')) {
                        alert('âš ï¸ Recall Mode requires OpenAI API key.\n\nPlease add OPENAI_API_KEY to your Replit Secrets to enable AI-powered task recall and execution.');
                    } else {
                        alert('Error: ' + errorMsg);
                    }
                }
            } catch (error) {
                console.error('Error recalling task:', error);
                alert('Network error while recalling task. Please try again.');
            }
        }

        function displayRecallResults(results) {
            document.getElementById('recallResults').classList.remove('hidden');
            document.getElementById('matchCount').textContent = `${results.length} matches`;
            
            const container = document.getElementById('recallResultsContent');
            
            if (!results || results.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #555555; padding: 40px 0;">No matching tasks found</div>';
                return;
            }
            
            container.innerHTML = results.map((result, index) => {
                const score = Math.round(result.similarity_score * 100);
                const scoreColor = score >= 80 ? '#10b981' : score >= 60 ? '#f59e0b' : '#dc2626';
                
                return `
                    <div style="background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 10px; padding: 16px; margin-bottom: ${index === results.length - 1 ? '0' : '12px'};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="font-size: 16px; font-weight: 600; color: #ffffff;">${result.task_name}</span>
                                    <span style="font-size: 12px; font-weight: 700; color: ${scoreColor}; background: ${scoreColor}20; padding: 4px 8px; border-radius: 4px;">
                                        ${score}% match
                                    </span>
                                </div>
                                <p style="font-size: 13px; color: #888888; margin: 0;">
                                    ${result.description || 'No description'}
                                </p>
                            </div>
                            <button class="icon-button" onclick="executeTask('${result.task_id}')" title="Execute Task" style="margin-left: 12px;">
                                <i class="bi bi-play-fill"></i>
                            </button>
                        </div>
                        ${result.tags && result.tags.length > 0 ? `
                            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                ${result.tags.map(tag => `
                                    <span style="font-size: 11px; background: rgba(139, 92, 246, 0.2); color: #a78bfa; padding: 4px 10px; border-radius: 4px;">
                                        ${tag}
                                    </span>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        loadHistory();
        detectSystemInfo();
        let allScripts = [];
        let currentTestScriptData = {
            historyId: null,
            generatedCode: null,
            healedCode: null
        };

        async function loadScriptsLibrary() {
            try {
                const response = await fetch('/api/scripts/list');
                const data = await response.json();
                
                allScripts = data.scripts || [];
                
                const totalScripts = allScripts.length;
                const healedScripts = allScripts.filter(s => s.has_healed).length;
                const taskScripts = allScripts.filter(s => s.source === 'task').length;
                
                document.getElementById('totalScripts').textContent = totalScripts;
                document.getElementById('healedScripts').textContent = healedScripts;
                document.getElementById('taskScripts').textContent = taskScripts;
                
                displayScripts(allScripts);
            } catch (error) {
                console.error('Error loading scripts:', error);
                document.getElementById('scriptsContent').innerHTML = '<div style="text-align: center; color: #dc2626; padding: 60px 0;">Error loading scripts</div>';
            }
        }

        function displayScripts(scripts) {
            const scriptsContent = document.getElementById('scriptsContent');
            
            if (scripts.length === 0) {
                scriptsContent.innerHTML = '<div style="text-align: center; color: #555555; padding: 60px 0;">No scripts found</div>';
                return;
            }
            
            let html = '';
            scripts.forEach(script => {
                const sourceIcon = script.source === 'task' ? 'book-fill' : 'code-square';
                const sourceColor = script.source === 'task' ? '#f59e0b' : '#8b5cf6';
                const statusBadge = script.has_healed ? 
                    '<span style="font-size: 11px; background: rgba(16, 185, 129, 0.2); color: #10b981; padding: 4px 8px; border-radius: 4px;">HEALED</span>' :
                    script.status ? `<span style="font-size: 11px; background: rgba(139, 92, 246, 0.2); color: #a78bfa; padding: 4px 8px; border-radius: 4px;">${script.status.toUpperCase()}</span>` : '';
                
                html += `
                    <div style="background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 12px; padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <i class="bi bi-${sourceIcon}" style="color: ${sourceColor}; font-size: 18px;"></i>
                                    <h3 style="font-size: 16px; font-weight: 600; margin: 0;">${script.name}</h3>
                                    ${statusBadge}
                                </div>
                                <p style="font-size: 13px; color: #888888; margin: 0;">${script.description}</p>
                                ${script.success_rate !== undefined ? `<div style="font-size: 12px; color: #10b981; margin-top: 6px;">Success Rate: ${script.success_rate}%</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="icon-button" onclick="downloadScript('${script.source}', '${script.history_id || script.task_id}')" title="Download script">
                                    <i class="bi bi-download"></i>
                                </button>
                                ${script.source === 'history' && script.has_healed ? `
                                <button class="icon-button" onclick="compareScripts(${script.history_id})" title="View changes">
                                    <i class="bi bi-file-diff"></i>
                                </button>
                                ` : ''}
                            </div>
                        </div>
                        <div style="font-size: 11px; color: #555555;">
                            Created: ${new Date(script.created_at).toLocaleDateString()} ${new Date(script.created_at).toLocaleTimeString()}
                        </div>
                    </div>
                `;
            });
            
            scriptsContent.innerHTML = html;
        }

        function filterScripts() {
            const searchTerm = document.getElementById('scriptSearchInput').value.toLowerCase();
            const filtered = allScripts.filter(script => 
                script.name.toLowerCase().includes(searchTerm) ||
                (script.description && script.description.toLowerCase().includes(searchTerm))
            );
            displayScripts(filtered);
        }

        async function downloadScript(source, id) {
            const url = source === 'task' ? `/api/scripts/download/task/${id}` : `/api/scripts/download/history/${id}`;
            window.location.href = url;
        }

        async function compareScripts(historyId) {
            try {
                const response = await fetch(`/api/scripts/compare/${historyId}`);
                const data = await response.json();
                
                if (!data.has_healed) {
                    alert(data.message);
                    return;
                }
                
                let changesList = '';
                data.changes.forEach(change => {
                    changesList += `Line ${change.line}:\n`;
                    changesList += `  - ${change.original}\n`;
                    changesList += `  + ${change.healed}\n\n`;
                });
                
                alert(`Script Healing Changes (${data.total_changes} changes):\n\n${changesList}`);
            } catch (error) {
                console.error('Error comparing scripts:', error);
                alert('Error loading script comparison');
            }
        }

        function downloadGeneratedScript() {
            if (!currentTestScriptData.historyId) {
                alert('No generated script available to download');
                return;
            }
            downloadScript('history', currentTestScriptData.historyId);
        }

        function downloadHealedScript() {
            if (!currentTestScriptData.historyId) {
                alert('No healed script available to download');
                return;
            }
            downloadScript('history', currentTestScriptData.historyId);
        }

        socket.on('execution_result', (data) => {
            if (data.test_id) {
                currentTestScriptData.historyId = data.test_id;
                currentTestScriptData.generatedCode = data.code;
                
                if (data.code) {
                    document.getElementById('downloadGeneratedBtn').style.display = 'block';
                }
            }
        });

        socket.on('script_healed', (data) => {
            if (data.test_id) {
                currentTestScriptData.healedCode = data.healed_script;
                document.getElementById('downloadHealedBtn').style.display = 'block';
            }
        });

    </script>
</body>
</html>
