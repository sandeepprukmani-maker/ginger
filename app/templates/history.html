{% extends "base.html" %}

{% block title %}Execution History{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Execution History</h1>
    <p class="page-description">View your past automation executions and results</p>
</div>

<div class="top-bar">
    <button class="btn btn-danger" id="delete-all-btn">
        <span class="btn-icon"><i data-feather="trash-2"></i></span>
        Delete All
    </button>
    <button class="btn btn-primary" id="refresh-btn">
        <span class="btn-icon"><i data-feather="refresh-cw"></i></span>
        Refresh
    </button>
</div>

<div id="history-container">
    <div class="empty-state" id="empty-state">
        <div class="empty-state-icon"><i data-feather="clipboard"></i></div>
        <p>No executions yet</p>
    </div>
</div>

<div id="detail-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Execution Details</h2>
            <button class="modal-close" id="close-modal">
                <i data-feather="x"></i>
            </button>
        </div>
        <div class="modal-body" id="modal-body">
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
const HISTORY_API = '/api/history';

let currentPage = 1;
let totalPages = 1;

async function loadHistory(page = 1) {
    try {
        const response = await fetch(`${HISTORY_API}?page=${page}&per_page=20`);
        const data = await response.json();
        
        if (data.success) {
            displayHistory(data.history);
            currentPage = data.page;
            totalPages = data.pages;
            
            if (data.history.length === 0) {
                document.getElementById('empty-state').style.display = 'block';
            } else {
                document.getElementById('empty-state').style.display = 'none';
            }
        } else {
            console.error('Failed to load history:', data.message);
        }
    } catch (error) {
        console.error('Error loading history:', error);
    }
}

function displayHistory(history) {
    const container = document.getElementById('history-container');
    
    if (history.length === 0) {
        return;
    }
    
    const historyHTML = history.map(item => {
        const date = new Date(item.created_at);
        const formattedDate = date.toLocaleString();
        const statusClass = item.success ? 'success' : 'error';
        const statusIcon = item.success ? 'check-circle' : 'x-circle';
        const modeIcon = item.headless ? 'eye-off' : 'eye';
        const engineIcon = item.engine === 'browser_use' ? 'cpu' : 'code';
        
        return `
            <div class="history-card">
                <div class="history-header">
                    <div class="history-meta">
                        <div class="history-status ${statusClass}">
                            <i data-feather="${statusIcon}"></i>
                            <span>${item.success ? 'Success' : 'Failed'}</span>
                        </div>
                        <div class="history-date">${formattedDate}</div>
                    </div>
                    <button class="btn btn-secondary btn-sm" onclick="deleteHistoryItem(${item.id})">
                        <span class="btn-icon"><i data-feather="trash-2"></i></span>
                    </button>
                </div>
                
                <div class="history-info">
                    <div class="info-badge">
                        <i data-feather="${modeIcon}"></i>
                        <span>${item.headless ? 'Headless' : 'Headful'}</span>
                    </div>
                    <div class="info-badge">
                        <i data-feather="${engineIcon}"></i>
                        <span>${item.engine === 'browser_use' ? 'Browser Use' : 'Playwright MCP'}</span>
                    </div>
                    ${item.iterations ? `<div class="info-badge"><span>${item.iterations} steps</span></div>` : ''}
                </div>
                
                <div class="history-prompt">
                    <strong>Prompt:</strong>
                    <p>${escapeHtml(item.prompt)}</p>
                </div>
                
                ${item.error_message ? `
                    <div class="history-error">
                        <strong>Error:</strong>
                        <p>${escapeHtml(item.error_message)}</p>
                    </div>
                ` : ''}
                
                <button class="btn btn-primary btn-block" onclick="viewDetails(${item.id})">
                    <span class="btn-icon"><i data-feather="eye"></i></span>
                    View Full Details
                </button>
            </div>
        `;
    }).join('');
    
    container.innerHTML = historyHTML + '<div id="empty-state" class="empty-state" style="display: none;"><div class="empty-state-icon"><i data-feather="clipboard"></i></div><p>No executions yet</p></div>';
    feather.replace();
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function viewDetails(id) {
    try {
        const response = await fetch(`${HISTORY_API}/${id}`);
        const data = await response.json();
        
        if (data.success) {
            const item = data.history;
            const modalBody = document.getElementById('modal-body');
            
            modalBody.innerHTML = `
                <div class="detail-grid">
                    ${item.generated_script ? `
                        <div class="detail-section">
                            <h3><i data-feather="file-text"></i> Generated Script</h3>
                            <div class="output-panel">
                                <pre><code>${escapeHtml(item.generated_script)}</code></pre>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${item.healed_script ? `
                        <div class="detail-section">
                            <h3><i data-feather="refresh-cw"></i> Healed Script</h3>
                            <div class="output-panel">
                                <pre><code>${escapeHtml(item.healed_script)}</code></pre>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${item.screenshot_path ? `
                        <div class="detail-section">
                            <h3><i data-feather="camera"></i> Screenshot</h3>
                            <div class="output-panel">
                                <img src="${item.screenshot_path}" alt="Screenshot" style="max-width: 100%;">
                            </div>
                        </div>
                    ` : ''}
                    
                    ${item.execution_logs ? `
                        <div class="detail-section">
                            <h3><i data-feather="list"></i> Execution Logs</h3>
                            <div class="output-panel">
                                <pre>${formatLogs(item.execution_logs)}</pre>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('detail-modal').style.display = 'flex';
            feather.replace();
        }
    } catch (error) {
        console.error('Error loading details:', error);
    }
}

function formatLogs(logsJson) {
    try {
        const logs = JSON.parse(logsJson);
        if (Array.isArray(logs)) {
            return logs.map((log, i) => `${i + 1}. ${escapeHtml(JSON.stringify(log, null, 2))}`).join('\n\n');
        }
        return escapeHtml(JSON.stringify(logs, null, 2));
    } catch {
        return escapeHtml(logsJson);
    }
}

async function deleteHistoryItem(id) {
    if (!confirm('Are you sure you want to delete this execution?')) {
        return;
    }
    
    try {
        const response = await fetch(`${HISTORY_API}/${id}`, {
            method: 'DELETE'
        });
        const data = await response.json();
        
        if (data.success) {
            loadHistory(currentPage);
        } else {
            alert('Failed to delete: ' + data.message);
        }
    } catch (error) {
        console.error('Error deleting item:', error);
        alert('Failed to delete item');
    }
}

async function deleteAllHistory() {
    if (!confirm('Are you sure you want to delete ALL execution history? This cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(HISTORY_API, {
            method: 'DELETE'
        });
        const data = await response.json();
        
        if (data.success) {
            loadHistory(1);
        } else {
            alert('Failed to delete: ' + data.message);
        }
    } catch (error) {
        console.error('Error deleting all:', error);
        alert('Failed to delete all history');
    }
}

document.getElementById('refresh-btn').addEventListener('click', () => {
    loadHistory(currentPage);
});

document.getElementById('delete-all-btn').addEventListener('click', deleteAllHistory);

document.getElementById('close-modal').addEventListener('click', () => {
    document.getElementById('detail-modal').style.display = 'none';
});

window.addEventListener('click', (e) => {
    const modal = document.getElementById('detail-modal');
    if (e.target === modal) {
        modal.style.display = 'none';
    }
});

loadHistory();
feather.replace();
</script>
{% endblock %}
